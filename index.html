<!doctype html>
<html lang="pt-PT">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa OSM Online</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #F5E9D0;
      --accent: #E47D29;
      --card: #fff;
      --muted: #6b6b6b;
      --glass: rgba(255, 255, 255, 0.88);
      --panel-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: "Inter", Arial, sans-serif;
      background: var(--bg);
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* Search (top-right) */
    .search-box {
      position: absolute;
      top: 12px;
      right: 20px;
      z-index: 1400;
    }

    .search-box input {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      width: 280px;
      font-size: 14px;
      background: #fff;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 6px rgba(228, 125, 41, 0.18);
    }

    #searchResults {
      position: absolute;
      top: 46px;
      right: 0;
      z-index: 1500;
      width: 350px;
      max-height: 300px;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      display: none;
      padding: 10px;
    }

    #searchResults li {
      list-style: none;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #searchResults li:hover {
      background: #fbefe0;
    }

    /* Estilo para exibir categoria, nome e imagem do item */
    .result-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .result-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      background-color: #eee;
    }

    .result-item .m-title {
      font-weight: bold;
      color: var(--accent);
    }

    .result-item .m-cat {
      font-size: 12px;
      color: var(--muted);
    }

    /* Bot√£o Digitais (canto inferior direito) */
    #digitalBtn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1500;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      font-size: 24px;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
      transition: transform 0.2s ease, background 0.2s;
    }

    #digitalBtn:hover {
      background: #d66a1f;
      transform: scale(1.05);
    }

    /* Painel Digitais */
    #digitalPanel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 360px;
      max-height: 70vh;
      background: var(--glass);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      box-shadow: var(--panel-shadow);
      border: 1px solid rgba(0, 0, 0, 0.08);
      display: none;
      flex-direction: column;
      z-index: 2000;
      overflow: hidden;
      animation: fadeIn 0.2s ease;
    }

    #digitalPanel.open {
      display: flex;
    }

    #digitalPanel h3 {
      margin: 0;
      padding: 12px 16px;
      background: var(--accent);
      color: white;
      font-size: 16px;
      text-align: center;
    }

    #digitalList {
      list-style: none;
      margin: 0;
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }

    #digitalList li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      background: white;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    #digitalList li:hover {
      background: #fbefe0;
    }

    #digitalList img {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      object-fit: cover;
      background: #eee;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }


    /* Side panel (responsive) */
    .side-panel {
      position: fixed;
      right: 18px;
      top: 56px;
      width: 35%;
      max-width: 400px;
      min-width: 280px;
      height: calc(100vh - 96px);
      background: var(--glass);
      border-radius: 12px;
      box-shadow: var(--panel-shadow);
      z-index: 2000;
      transform: translateX(420px);
      transition: transform 260ms ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(0, 0, 0, 0.04);
      backdrop-filter: blur(4px);
    }

    .side-panel.open {
      transform: translateX(0);
    }

    @media(max-width:900px) {
      .side-panel {
        width: 90%;
        right: 6px;
        transform: translateX(110%);
      }
    }

    .panel-header {
      position: relative;
      padding: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.98));
    }

    .panel-header img {
      width: 300px;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
      border: 4px solid rgba(255, 255, 255, 0.85);
      background: #eee;
    }

    .panel-name {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      text-align: center;
      margin-top: 6px;
    }

    .panel-cat {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }

    .media-row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-top: 6px;
    }

    .media-row a {
      display: inline-flex;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      border: 1px solid rgba(0, 0, 0, 0.06);
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      font-size: 16px;
    }

    .panel-body {
      padding: 12px 16px;
      overflow: auto;
      flex: 1;
    }

    .section-title {
      color: var(--accent);
      font-weight: 700;
      margin: 10px 0;
      font-size: 13px;
    }

    .about {
      font-size: 14px;
      color: #333;
      margin-bottom: 12px;
      white-space: pre-wrap;
    }

    .info-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 15px 0;
    }

    .info-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex: 0 0 34px;
    }

    .info-text {
      font-size: 14px;
      color: #333;
      word-break: break-word;
    }

    .static-activities {
      margin-top: 12px;
      padding: 10px;
      background: #fff6f0;
      border-radius: 8px;
      border: 1px solid rgba(228, 125, 41, 0.06);
      color: var(--muted);
      font-size: 13px;
    }

    .panel-close {
      position: absolute;
      right: 12px;
      top: 12px;
      background: rgba(0, 0, 0, 0.06);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
    }

    /* Filters bottom-left */
    .filter-panel {
      position: absolute;
      left: 16px;
      bottom: 16px;
      z-index: 1300;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      max-width: 260px;
    }

    .filter-item {
      border-radius: 25px;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      color: var(--accent);
      font-size: 13px;
    }

    .filter-item.active {
      background: var(--accent);
      color: #fff;
    }

    .filter-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      /* Centraliza horizontalmente */
    }

    .toggle-all {
      padding: 6px 10px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }

    /* leaflet z-index */
    .leaflet-container {
      z-index: 0;
    }
  </style>
</head>

<body>

  <div class="search-box">
    <input id="searchInput" type="text" placeholder="üîç Pesquisar organiza√ß√µes..." />
    <ul id="searchResults"></ul>
  </div>

  <!-- Bot√£o Digitais -->
  <button id="digitalBtn" title="Ver Associa√ß√µes Digitais">üíª</button>

  <!-- Painel com lista de Digitais -->
  <div id="digitalPanel">
    <h3>üåê Associa√ß√µes Digitais</h3>
    <ul id="digitalList"></ul>
  </div>


  <div id="map"></div>

  <!-- Filters bottom-left -->
  <div id="filterPanel" class="filter-panel" aria-hidden="false"></div>

  <!-- SIDE PANEL -->
  <aside id="sidePanel" class="side-panel" aria-hidden="true">
    <div class="panel-header">
      <button id="closePanel" class="panel-close" title="Fechar">‚úï</button>
      <img id="panelImg" src="" alt="Imagem" />
      <div class="panel-name" id="panelName">Nome</div>
      <div class="panel-cat" id="panelCat">Categoria</div>
      <div class="media-row" id="panelMedia"></div>
    </div>

    <div class="panel-body" id="panelBody">
      <div>
        <div class="section-title">Sobre</div>
        <div class="about" id="panelAbout">Proposito</div>
      </div>

      <div>
        <div class="section-title">Morada</div>
        <div class="info-row">
          <div class="info-icon">
            <img src="icons_list/iconAddress.svg" alt="Morada" class="icon-svg">
          </div>
          <div class="info-text" id="panelAddress">Endere√ßo completo</div>
        </div>

        <div class="section-title">Telefone</div>
        <div class="info-row">
          <div class="info-icon">
            <img src="icons_list/iconCall.svg" alt="Telefone" class="icon-svg">
          </div>
          <div class="info-text" id="panelPhone">+351 ...</div>
        </div>

        <div class="section-title">Email</div>
        <div class="info-row">
          <div class="info-icon">
            <img src="icons_list/iconEmail.svg" alt="Email" class="icon-svg">
          </div>
          <div class="info-text" id="panelEmail">email@exemplo.pt</div>
        </div>

        <div class="section-title">Website</div>
        <div class="info-row">
          <div class="info-icon">
            <img src="icons_list/iconWebsite.svg" alt="Website" class="icon-svg">
          </div>
          <div class="info-text" id="panelWebsite">https://...</div>
        </div>

        <div class="info-row">

          <div class="static-activities">
            Atividades: exposi√ß√µes, oficinas, congressos e eventos....
          </div>
        </div>
      </div>
    </div>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    fetch('data.json').then(r => r.json()).then(data => {
      const todos = Array.isArray(data) ? data : [];

      const fisicas = todos.filter(d => (d.type || '').toLowerCase() === 'fisica' && d.address && d.address.latitude && d.address.longitude);
      const digitais = todos.filter(d => (d.type || '').toLowerCase() === 'digital');
      const pesquisaveis = [...fisicas, ...digitais];

      const map = L.map('map').setView([38.72, -9.18], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // === Refer√™ncias da interface ===
      const sidePanel = document.getElementById('sidePanel');
      const closePanelBtn = document.getElementById('closePanel');
      const panelImg = document.getElementById('panelImg');
      const panelName = document.getElementById('panelName');
      const panelCat = document.getElementById('panelCat');
      const panelMedia = document.getElementById('panelMedia');
      const panelAbout = document.getElementById('panelAbout');
      const panelAddress = document.getElementById('panelAddress');
      const panelPhone = document.getElementById('panelPhone');
      const panelEmail = document.getElementById('panelEmail');
      const panelWebsite = document.getElementById('panelWebsite');

      // === Fun√ß√£o para gerar popup curto ===
      function gerarPopupHTML(o) {
        const thumb = o.img
          ? `<img src="${o.img}" alt="${(o.nome || '')}" 
        style="width:48px;height:48px;object-fit:cover;border-radius:50%;border:none;" />`
          : ''; // sem fundo quando n√£o h√° imagem

        return `
    <div class="mini-popup" 
         style="display:flex;align-items:center;gap:10px;">
      ${thumb}
      <div class="m-title" 
           style="color:var(--accent);font-weight:700;font-size:15px;">
        ${o.nome || ''}
      </div>
    </div>`;
      }


      // === Abrir painel lateral com dados ===
      function openPanelFor(o) {
        // --- imagem ---
        if (o.img) {
          panelImg.src = o.img;
          panelImg.style.display = 'block';
        } else {
          panelImg.src = '';
          panelImg.style.display = 'none'; // ‚úÖ oculta quando n√£o h√° imagem
        }

        // --- textos e info ---
        panelName.textContent = o.nome || '-';
        const categoriaMap = {
          'grupo': 'Grupo',
          'coletivo_cultural': 'Coletivo Cultural',
          'associacao': 'Associa√ß√£o',
          'empresa_social': 'Empresa Social',
          'outros': 'Outros'
        };
        panelCat.textContent = categoriaMap[o.categoria?.toLowerCase()] || (o.categoria ? o.categoria.charAt(0).toUpperCase() + o.categoria.slice(1) : '-');

        panelAbout.textContent = o.proposito || o.description || o.sobre || 'Sem descri√ß√£o dispon√≠vel.';

        // Morada ‚Äî mostra o endere√ßo vis√≠vel e clic√°vel
        if (o.address && (o.address.latitude && o.address.longitude)) {
          const lat = o.address.latitude;
          const lon = o.address.longitude;
          const addr = o.address.fullAddress || 'Abrir no Google Maps';
          panelAddress.innerHTML = `<a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" rel="noopener" style="color:var(--accent); text-decoration:none">${addr}</a>`;
        } else if (o.address && o.address.fullAddress) {
          const addr = o.address.fullAddress;
          const query = encodeURIComponent(addr);
          panelAddress.innerHTML = `<a href="https://www.google.com/maps/search/?api=1&query=${query}" target="_blank" rel="noopener" style="color:var(--accent); text-decoration:none">${addr}</a>`;
        } else {
          panelAddress.textContent = 'N√£o possui morada f√≠sica.';
        }


        // Telefone
        panelPhone.innerHTML = o.telefone
          ? `<a href="tel:${o.telefone}" style="color:var(--accent); text-decoration:none">${o.telefone}</a>`
          : 'N√£o possui telefone.';

        // Email
        panelEmail.innerHTML = o.email
          ? `<a href="mailto:${o.email}" style="color:var(--accent); text-decoration:none">${o.email}</a>`
          : 'N√£o possui email.';

        // Website
        panelWebsite.innerHTML = o.website
          ? `<a href="${o.website}" target="_blank" rel="noopener" style="color:var(--accent); text-decoration:none">${o.website}</a>`
          : 'N√£o possui website.';

        // --- redes sociais ---
        panelMedia.innerHTML = '';
        const links = o.mediaLinks || {};
        const icons = {
          website: 'üåê', facebook: 'üìò', instagram: 'üì∏',
          tiktok: 'üéµ', linkedin: 'üíº', youtube: '‚ñ∂Ô∏è'
        };
        Object.entries(links).forEach(([key, url]) => {
          if (url) {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.rel = 'noopener';
            a.innerText = icons[key] || 'üîó';
            panelMedia.appendChild(a);
          }
        });

        sidePanel.classList.add('open');
        sidePanel.setAttribute('aria-hidden', 'false');
      }

      function closePanel() {
        sidePanel.classList.remove('open');
        sidePanel.setAttribute('aria-hidden', 'true');
      }
      closePanelBtn.addEventListener('click', closePanel);

      // === Criar marcadores agrupados por categoria ===
      const categorias = {};
      fisicas.forEach(o => {
        const cat = o.categoria || 'Outros';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push(o);
      });

      const layers = {};
      const allMarkers = [];

      Object.entries(categorias).forEach(([cat, orgs]) => {
        const layer = L.layerGroup();
        orgs.forEach(o => {
          const lat = parseFloat(o.address.latitude), lon = parseFloat(o.address.longitude);
          if (isNaN(lat) || isNaN(lon)) return;

          const marker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: `icons/${cat}.svg`,
              iconSize: [44, 44],
              iconAnchor: [22, 22],
              popupAnchor: [0, -22]
            })
          });

          marker.bindPopup(gerarPopupHTML(o), { closeButton: false, offset: [0, -8] });
          marker.on('click', () => {
            marker.openPopup();
            openPanelFor(o);
            map.panTo([lat, lon], { animate: true });
          });

          marker.addTo(layer);
          marker.orgData = o;
          allMarkers.push(marker);
        });
        layers[cat] = layer;
        layer.addTo(map);
      });

      // === Painel de filtros ===
      const filterPanel = document.getElementById('filterPanel');
      Object.keys(layers).forEach(cat => {
        const btn = document.createElement('div');
        btn.className = 'filter-item active';
        const iconUrl = `icons_filter/${cat}.svg`;

        const iconImg = document.createElement('img');
        iconImg.src = iconUrl;
        iconImg.alt = cat;
        iconImg.style.width = '80px';
        iconImg.style.height = '80px';
        iconImg.style.objectFit = 'contain';

        btn.appendChild(iconImg);
        const categoryName = document.createElement('span');
        categoryName.textContent = cat;
        categoryName.style.display = 'none';
        btn.appendChild(categoryName);

        btn.addEventListener('click', () => {
          if (map.hasLayer(layers[cat])) {
            map.removeLayer(layers[cat]);
            btn.classList.remove('active');
          } else {
            map.addLayer(layers[cat]);
            btn.classList.add('active');
          }
        });

        filterPanel.appendChild(btn);
      });

      // === Bot√£o de alternar todos ===
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'filter-controls';
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'toggle-all';
      toggleBtn.textContent = 'üëÅÔ∏è Ocultar Todas';
      let allVisible = true;
      toggleBtn.addEventListener('click', () => {
        allVisible = !allVisible;
        toggleBtn.textContent = allVisible ? 'üëÅÔ∏è Ocultar Todas' : 'üëÅÔ∏è Mostrar Todas';
        Object.entries(layers).forEach(([cat, layer]) => {
          const btn = Array.from(filterPanel.children).find(el => el.textContent === cat);
          if (allVisible) { map.addLayer(layer); btn.classList.add('active'); }
          else { map.removeLayer(layer); btn.classList.remove('active'); }
        });
      });
      controlsDiv.appendChild(toggleBtn);
      filterPanel.appendChild(controlsDiv);

      // === PESQUISA ===
      const searchInput = document.getElementById('searchInput');
      const resultsList = document.getElementById('searchResults');

      searchInput.addEventListener('input', e => {

        const q = e.target.value.toLowerCase().trim();
        searchInput.placeholder = q ? `Pesquisando: ${q}` : 'üîç Pesquisar organiza√ß√µes...';

        resultsList.innerHTML = '';
        if (!q) {
          resultsList.style.display = 'none';
          return;
        }

        const results = pesquisaveis.filter(o => (o.nome || '').toLowerCase().includes(q));

        // ‚úÖ MOSTRAR MENSAGEM QUANDO N√ÉO H√Å RESULTADOS
        if (results.length === 0) {
          resultsList.innerHTML = `<li style="color:#999; text-align:center; padding:12px;">Nenhuma registro encontrado.</li>`;
          resultsList.style.display = 'block';
          return;
        }

        results.forEach(o => {
          const li = document.createElement('li');
          li.className = 'result-item';

          // imagem s√≥ se existir
          const image = o.img
            ? `<img src="${o.img}" alt="${o.nome}" />`
            : '';

          const title = `<div class="m-title">${o.nome}</div>`;
          const category = `<div class="m-cat">${o.categoria}</div>`;
          li.innerHTML = `${image}${title}${category}`;

          li.addEventListener('click', () => {
            resultsList.innerHTML = '';
            resultsList.style.display = 'none';
            openPanelFor(o);

            const lat = o?.address?.latitude;
            const lon = o?.address?.longitude;
            if (lat && lon) {
              const latNum = parseFloat(lat), lonNum = parseFloat(lon);
              if (!isNaN(latNum) && !isNaN(lonNum)) {
                map.setView([latNum, lonNum], 15, { animate: true });
                L.popup({ closeButton: false, offset: [0, -8] })
                  .setLatLng([latNum, lonNum])
                  .setContent(gerarPopupHTML(o))
                  .openOn(map);
              }
            }
          });

          resultsList.appendChild(li);
        });
        resultsList.style.display = 'block';
      });

      // === BOT√ÉO DIGITAIS ===
      const digitalBtn = document.getElementById('digitalBtn');
      const digitalPanel = document.getElementById('digitalPanel');
      const digitalList = document.getElementById('digitalList');

      digitalBtn.addEventListener('click', () => {
        digitalPanel.classList.toggle('open');

        if (digitalPanel.classList.contains('open')) {
          digitalList.innerHTML = '';

          if (digitais.length === 0) {
            digitalList.innerHTML = '<li>Nenhuma associa√ß√£o digital encontrada.</li>';
            return;
          }

          digitais.forEach(o => {
            const li = document.createElement('li');
            const img = document.createElement('img');
            img.src = o.img || 'default-image.png';
            img.alt = o.nome || 'Sem imagem';

            const infoDiv = document.createElement('div');
            const name = document.createElement('div');
            name.textContent = o.nome || '-';
            name.style.fontWeight = '700';
            name.style.color = 'var(--accent)';
            const cat = document.createElement('div');
            cat.textContent = o.categoria || '';
            cat.style.fontSize = '13px';
            cat.style.color = 'var(--muted)';

            infoDiv.appendChild(name);
            infoDiv.appendChild(cat);
            li.appendChild(img);
            li.appendChild(infoDiv);

            li.addEventListener('click', () => {
              openPanelFor(o);
              digitalPanel.classList.remove('open');
            });

            digitalList.appendChild(li);
          });
        }
      });

    }).catch(err => {
      console.error('Erro a carregar data.json', err);
      alert('Erro a carregar data.json ‚Äî confirma o ficheiro e o formato (ver console).');
    });
  </script>


</body>

</html>